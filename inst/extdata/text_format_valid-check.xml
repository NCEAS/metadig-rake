<?xml version="1.0" encoding="UTF-8"?>
<mdq:check xmlns:mdq="https://nceas.ucsb.edu/mdqe" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="https://nceas.ucsb.edu/mdqe ../schemas/schema1.xsd">
  <id>check.text.file.format.valid</id>
  <name>Text file is valid</name>
  <description>Check that a text file is formatted as expected.</description>
  <type>identification</type>
  <level>REQUIRED</level>
  <environment>rscript</environment>
  <code><![CDATA[
  library(metadigRake)
  library(metadig)

  for (i in seq_along(names)){

      if (!(format[i] %in% c("text/tsv", "text/csv", "text/plain"))){
          save_output(paste0("Skipped checking ", names[i], " because it wasn't in the list of supported formats."))
      } else {
          path <- tryCatch({
              mdq_get(url, FALSE)
          },
          error = function(e) {
              e
          }

          if (inherits(path, "error")) {
              save_output(paste0("Something went wrong when trying to download ", names[i]))
              next
          }

          if (textFormatsPresent & file.exists(fileName)){
              status <- check_text_file_format(path, fieldDelimiter[i], headerLines[i])

              if !(status){
                  save_output(paste0(names[i], "is not formatted correctly"))
              } else if (status){
                  success()
              }
          }
      }

  }


  ]]></code>
  <selector>
    <name>names</name>
    <xpath>/eml/dataset/*[self::dataTable|self::otherEntity]</xpath>
    <subSelector>
      <name>...</name>
      <xpath>./entityName</xpath>
    </subSelector>
  </selector>
  <selector>
    <name>formats</name>
    <xpath>/eml/dataset/*[self::dataTable|self::otherEntity]</xpath>
    <subSelector>
      <name>...</name>
      <xpath>.//formatName</xpath>
    </subSelector>
  </selector>
  <selector>
    <name>url</name>
    <xpath>/eml/dataset/*[self::dataTable|self::otherEntity]</xpath>
    <subSelector>
      <name>...</name>
      <xpath>./physical/distribution/online/url</xpath>
    </subSelector>
  </selector>
  <selector>
     <name>fieldDelimiter</name>
    <xpath>/eml/dataset/*[self::dataTable|self::otherEntity]</xpath>
     <subSelector>
        <name>...</name>
        <xpath>./physical/dataFormat/textFormat/simpleDelimited/fieldDelimiter</xpath>
    </subSelector>
  </selector>
  <selector>
     <name>headerLines</name>
    <xpath>/eml/dataset/*[self::dataTable|self::otherEntity]</xpath>
     <subSelector>
        <name>...</name>
        <xpath>./physical/dataFormat/textFormat/numHeaderLines</xpath>
    </subSelector>
  </selector>
  <selector>
  <dialect>
    <name>eml</name>
    <xpath>boolean(/*[local-name() = 'eml'])</xpath>
  </dialect>
</mdq:check>
